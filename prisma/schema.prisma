// GenAI-Merch Database Schema
// Type-safe database access with Prisma ORM

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

// User accounts (synced with Clerk via webhooks)
model User {
  id            String               @id @default(cuid())
  clerkId       String?              @unique // Clerk user ID for authentication (nullable for migration)
  email         String               @unique
  name          String?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  organizations OrganizationMember[]
  designs       Design[]
  orders        Order[]
  groupOrders   GroupOrder[]
  carts         Cart[]
  addresses     Address[]
}

// Organizations for team/company accounts
model Organization {
  id           String               @id @default(cuid())
  name         String
  slug         String               @unique
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  members      OrganizationMember[]
  brandProfile BrandProfile?
}

// Brand profile for design consistency
model BrandProfile {
  id             String       @id @default(cuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  logoUrl        String?
  colorPalette   Json // Array of hex colors
  fonts          Json // Font specifications
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

// Custom apparel designs
model Design {
  id                 String      @id @default(cuid())
  userId             String
  user               User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  name               String
  imageUrl           String // Raster image (PNG/JPG)
  vectorUrl          String? // Vector file (SVG)
  metadata           Json // Design specifications (DPI, colors, dimensions)
  aiPrompt           String? // Original AI prompt if generated by AI
  printReadyUrl      String? // Print-ready file URL (optimized, upscaled, 300 DPI)
  printReadyMetadata Json? // Print preparation metadata (dimensions, upscaling, DPI, etc.)
  preparedAt         DateTime? // When design was prepared for print
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  cartItems          CartItem[]
  orderItems         OrderItem[]
}

// E-commerce Product Catalog (synced from Printful)
model Product {
  id          String             @id @default(cuid())
  printfulId  Int                @unique
  name        String
  description String?
  category    String // apparel, accessories, home-living
  productType String // t-shirt, hoodie, mug, etc.
  basePrice   Int // Price in cents
  currency    String             @default("USD")
  imageUrl    String?
  mockupUrl   String?
  active      Boolean            @default(true)
  metadata    Json? // Printful product data
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  variants    ProductVariant[]
  techniques  ProductTechnique[]

  @@index([printfulId])
  @@index([category])
  @@index([productType])
  @@index([active])
}

// Product size/color variants
model ProductVariant {
  id                String      @id @default(cuid())
  productId         String
  product           Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  printfulVariantId Int         @unique
  name              String // e.g., "Medium / Black"
  size              String?
  color             String?
  price             Int // Price in cents
  inStock           Boolean     @default(true)
  imageUrl          String?
  metadata          Json? // Printful variant data
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  cartItems         CartItem[]
  orderItems        OrderItem[]

  @@index([printfulVariantId])
  @@index([productId])
}

// Printing techniques available for each product (synced from Printful)
model ProductTechnique {
  id          String                      @id @default(cuid())
  productId   String
  product     Product                     @relation(fields: [productId], references: [id], onDelete: Cascade)
  technique   String // dtg, dtfilm, embroidery, digital
  label       String // User-friendly label
  description String? // User-friendly description
  isDefault   Boolean                     @default(false) // Recommended technique for this product
  createdAt   DateTime                    @default(now())
  updatedAt   DateTime                    @updatedAt
  placements  ProductTechniquePlacement[]

  @@unique([productId, technique])
  @@index([productId])
  @@index([technique])
}

// Placements available for each product + technique combination
model ProductTechniquePlacement {
  id                 String           @id @default(cuid())
  productTechniqueId String
  productTechnique   ProductTechnique @relation(fields: [productTechniqueId], references: [id], onDelete: Cascade)
  placement          String // front, back, embroidery_front, front_dtf_hat, etc.
  label              String // User-friendly label
  createdAt          DateTime         @default(now())

  @@unique([productTechniqueId, placement])
  @@index([productTechniqueId])
}

// Shopping cart for users
model Cart {
  id        String     @id @default(cuid())
  userId    String?
  user      User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionId String? // For guest carts
  expiresAt DateTime?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  items     CartItem[]

  @@index([userId])
  @@index([sessionId])
}

// Items in shopping cart
model CartItem {
  id                String         @id @default(cuid())
  cartId            String
  cart              Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productVariantId  String
  productVariant    ProductVariant @relation(fields: [productVariantId], references: [id])
  designId          String?
  design            Design?        @relation(fields: [designId], references: [id], onDelete: SetNull)
  customizationData Json? // Design URL, placement, mockup preview
  quantity          Int            @default(1)
  unitPrice         Int // Frozen price in cents at add-to-cart time
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@index([cartId])
}

// Customer orders
model Order {
  id                      String               @id @default(cuid())
  userId                  String
  user                    User                 @relation(fields: [userId], references: [id])
  groupOrderId            String?
  groupOrder              GroupOrder?          @relation(fields: [groupOrderId], references: [id])
  orderNumber             String               @unique
  status                  String               @default("PENDING_PAYMENT") // PENDING_PAYMENT, PAID, SUBMITTED_TO_POD, IN_PRODUCTION, SHIPPED, DELIVERED, CANCELLED, REFUNDED
  stripePaymentIntentId   String?
  stripeCheckoutSessionId String?
  printfulOrderId         Int?
  printfulStatus          String?
  subtotal                Int // In cents
  shipping                Int // In cents
  tax                     Int // In cents
  total                   Int // In cents
  currency                String               @default("USD")
  shippingAddressId       String?
  shippingAddress         Address?             @relation(fields: [shippingAddressId], references: [id])
  trackingNumber          String?
  trackingUrl             String?
  carrier                 String?
  metadata                Json?
  createdAt               DateTime             @default(now())
  paidAt                  DateTime?
  shippedAt               DateTime?
  deliveredAt             DateTime?
  updatedAt               DateTime             @updatedAt
  items                   OrderItem[]
  statusHistory           OrderStatusHistory[]

  @@index([userId])
  @@index([status])
  @@index([printfulOrderId])
  @@index([orderNumber])
}

// Items in an order (frozen snapshot)
model OrderItem {
  id                String         @id @default(cuid())
  orderId           String
  order             Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productVariantId  String
  productVariant    ProductVariant @relation(fields: [productVariantId], references: [id])
  productName       String // Frozen from time of order
  variantName       String // Frozen from time of order
  designId          String?
  design            Design?        @relation(fields: [designId], references: [id], onDelete: SetNull)
  customizationData Json? // Design URL, placement, etc.
  quantity          Int
  unitPrice         Int // In cents
  thumbnailUrl      String?
  printfulItemId    Int?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@index([orderId])
}

// Group orders for team/event merchandise
model GroupOrder {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  deadline    DateTime
  status      String   @default("open") // open, closed, processing
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  orders      Order[]
}

// Organization membership and roles
model OrganizationMember {
  id             String       @id @default(cuid())
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  role           String       @default("member") // member, admin, owner
  createdAt      DateTime     @default(now())

  @@unique([userId, organizationId])
}

// Shipping addresses
model Address {
  id          String   @id @default(cuid())
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  email       String?
  phone       String?
  address1    String
  address2    String?
  city        String
  stateCode   String // e.g., "CA", "NY"
  countryCode String // e.g., "US", "CA"
  zip         String
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  orders      Order[]

  @@index([userId])
}

// Order status change audit trail
model OrderStatusHistory {
  id         String   @id @default(cuid())
  orderId    String
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  fromStatus String? // null for initial status
  toStatus   String
  changedBy  String // "system", "webhook:stripe", "webhook:printful", "admin:userId"
  reason     String?
  createdAt  DateTime @default(now())

  @@index([orderId])
  @@index([createdAt])
}
